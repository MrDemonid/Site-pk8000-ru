# Контроллер жёстких дисков. Ревизия 1.0

## Описание.

Первая версия контроллера IDE по схеме на КР580ВВ55 (аналог буржуйской i8055). 
Аналогичная схема давно и успешно используется для подключения подобных устройств
к другим компьютерам, например MSX.  

![Плата контроллера. Верх][board_top]
![Плата контроллера. Низ][board_bottom]

Для большей стабильности управляющие сигналы от ВВ55 на контроллер IDE идут через инвертор U3,
поскольку при смене режима чтения/записи внутренних регистров ВВ55, на её выходах (PA) появляется
низкий логический уровень, который является активным для контроллера IDE, что изредка приводило 
к глюкам и сбросу дисков.

![Схема контроллера][scheme_board]
![Спецификация][scheme_board_spec]

Контроллер подключается к ПК8000 по стандартному 40-жильному шлейфу IDE. Распиновку делали до меня и не учли,
что 20-й пин разъема, на который назначили сигнал A3, служит ключом для защиты от неправильного
подключения шлейфа. То есть этот штырёк почти всегда отсутствует на разъемах жёстких дисков,
а на шлейфах в этом месте нередко отсутствует отверстие, что и предотвращает установку шлейфа
в неправильном положении.  
Поэтому пришлось продублировать сигнал A3 на ближайший свободный пин - 16. Это позволило использовать
любой разъём и шлейф.

Дешифратор U1 обеспечивает доступ к регистрам ВВ55 через следующие порты ввода/вывода:

- 50h: PA - регистр управляющих линий контроллера IDE;
- 51h: PB - регистр старшего байта данных;
- 52h: PC - регистр младшего байта данных;
- 53h: регистр управления (задаёт режим чтения/записи регистров ВВ55)

Также в состав контроллера входит ПЗУ с прошивкой, которая берёт на себя всю низкоуровневую 
работу с жёсткими дисками, плюс содержит в себе адаптированную под ПК8000 систему CP/M. 
Содержимое ПЗУ отображается в адресное пространство компьютера, по адресам 4000h-7FFFh.

На момент разработки платы у меня не было программатора. Поэтому в качестве ПЗУ была использована
микросхема от старого Pentium, программируемая на аналогичной материнской плате.  
Это единственная причина использования 32-выводной микросхемы ПЗУ.

Размер ПЗУ может быть до 64 Кб и, чтобы не пропадать месту даром, можно хранить в ней
до 4-х различных прошивок по 16 Кб. Выбор прошивки осуществляется перемычками J3:

![Перемычки][jumpers]

Это позволяет, помимо ОС, хранить в ПЗУ прошивки от игрового автомата «Фотон».
Допустим, по адресу ПЗУ 0000h записана ОС, а по адресу 8000h записана игра «Питон».
Тогда, чтобы загрузить при старте ОС, нужно установить перемычки в положение 1, соответствующее
адресу 0000h в ПЗУ. А чтобы при старте запускалась игрушка, нужно выставить перемычки
в положение 3 (замкнув штыри 2-4 и 3-5).

Таким образом, можно легко превратить компьютер в игровой автомат, без создания
отдельного картриджа. Опознать такие игры довольно легко - они прописывают загрузчик
по адресу 4000h, соответственно после сброса будут стартовать снова и снова, до 
выключения питания компьютера.


## Ошибка в контроллере.

Схема подачи сигнала /CS для ВВ55 (U4) реализована классически, путем привязки к сигналам
/IOR и /IOW, возникающих когда процессору поступает команда обращения к какому-либо порту
ввода/вывода. Дешифратор U1 ограничивал сигнал /CS только портами 50h-53h.

Однако, уже после создания плат, когда начались жалобы на непонятные ошибки,
выяснилось, что сигнал /IOR слишком короткий и /CS на ВВ55 иногда закрывается еще до того,
как будут считаны данные из её регистров PB и PC.

Эта ошибка исправляется легко и практически без следов на плате.
Необходимо у микросхемы U2 (ЛА3) перерезать дорожку между выводами 6 и 9,
а также замкнуть ножки 9 и 10. То есть, просто отключаем завязку
на сигналы /IOR и /IOW. Расположение ножек и дорожек показано на схеме разводки ниже.


## Ошибка в документации.

Согласно документации ПК8000 на разъемы выходит сигнал аппаратного сброса /RESET.
Однако, этот сигнал оказался только на бумаге. Поэтому, подвисший в воздухе /RESET
иногда приводил к сбросу ВВ55 в самый неподходящий момент.  
Эта проблема решается тремя способами.
{.no-indent}
Сигнал /RESET приходит на 35-ю ножку микросхемы КР580ВВ55 (U4):

![Разводка платы][layout_board]

Здесь фиолетовым цветом показана дорожка от разъёма расширения ПК, до микросхемы ЛА3 (U2).
Жёлтым – от ЛА3 до непосредственно 35-й ножки КР580ВВ55 (U4). Красным - +5В, синим – земля.

### Вариант 1.

Самым очевидным решением является спаивание 13-й и 14-й ножек микросхемы U2 (ЛА3).
Тогда на ВВ55 всегда будет приходить сигнал низкого уровня. На всякий случай можно
перерезать дорожку непосредственно между разъемом J1 и резистором R5, чтобы не
подавать 5 вольт на разъем компьютера.

Или же можно откусить ножку 11 (жёлтая) микросхемы U2, и подпаять жёлтую дорожку к земле, 
например к синему выводу конденсатора C2, то есть также подав на ВВ55 низкий уровень. 

Недостаток данного метода очевиден – полное отсутствие аппаратного сброса.
С другой стороны, аппаратный сброс не особо и нужен, в крайнем случае можно просто выключить компьютер
и включить заново.



### Вариант 2.

Можно решить проблему в самом ПК8000, что более предпочтительно, учитывая, что сигнал сброса 
могут использовать и другие устройства, такие как контроллер AY.

Для этого, разбираем ПК8000 и подпаиваем +5 вольт прямо на разъемы расширения. Тогда
с разъема никогда не придет сброс и не будет подвисших в воздухе линий.

![На разъеме компьютера][fix_1]

На рисунке задняя панель компьютера. Выводы сигнала сброса (/RESET) здесь в чёрных кембриках, 
но скорее всего они будут пустыми. К ним и подпаиваем проводками +5 вольт, с места, 
обведённого красным кругом.   
Для надёжности лучше сделать это через резистор, примерно на 500 Ом.

Недостаток, как и у предыдущего варианта – полное отсутствие аппаратного сброса. Зато заранее
исключает проблемы с другими платами.


### Вариант 3.

Вывести на разъёмы расширения полноценный сигнал сброса. Он в ПК8000, разумеется, присутствует. 
Этот сигнал появляется на ножках 1 и 9, триггера TM2 (DD5), для сброса процессора и микросхем 
портов ввода/вывода. На рисунке ниже стрелкой показано расположение микросхемы TM2 на нижней 
плате компьютера:

![В компьютере][fix_2]

Можно конечно подпаяться прямо сверху платы к ножкам микросхемы. Но, всё же лучше сделать это снизу,
сняв плату:

![Вид снизу][fix_3]

{.no-indent}
Провод выводим на разъёмы, как в предыдущем варианте. Теперь ПК8000 соответствует документации,
точнее в плане сигнала /RESET.  
{.no-indent}
Собственно, там как раз и показан этот вариант доработки.



## Сборка.

По сборке особых замечаний нет. Разве что резисторы R7 и R8 можно не ставить, и без них всё работает.

Если используется ПЗУ на 32 ножки, то нужно внимательнее свериться с документацией на неё.
Ножки 1, 2, 31 и 32 не стандартизированы и у разных производителей могут иметь разные функции.

С программатором всё гораздо проще, подойдёт любая ПЗУ на 28 ножек, ёмкостью не меньше 16 Кб. 
Рекомендую W27C512-45Z. В этом случае резисторы R4 и R5 можно не устанавливать. 
Сама микросхема вставляется в панельку так, как показано на фото платы в начале статьи, т.е.
ножки панельки 1, 2, 31 и 32 остаются не задействованы.



## Ресурсы.

[Схема и разводка платы в DipTrace][original_scheme]



[board_top]: ./images/hdd-top-rev-1_0.png
[board_bottom]: ./images/hdd-bottom-rev-1_0.png
[scheme_board]: ./images/schema-hdd-rev-1_0.png
[scheme_board_spec]: ./images/schema-hdd-rev-1_0-power.png
[jumpers]: ./images/jumpers.jpg
[layout_board]: ./images/hdd-layout-rev-1_0.png
[fix_1]: ./images/fix_1.png
[fix_2]: ./images/fix_2_1.png
[fix_3]: ./images/fix_2_2.png

[original_scheme]: ./files/hdd-vv55-rev-1_0.zip

