# Контроллер часов реального времени (RTC).

Это мой первый опыт создания контроллеров для ПК8000. За основу взята схема от 
IBM PC-AT из технической библиотеки завода:

![Альбом принципиальных схем][book_title]
![Схема IBM PC/AT][book_scheme]

{.no-indent}
Часы реального времени выполнены на КР512ВИ1, аналоге буржуйской MC146818. 

![Плата, вид сверху][board_top]
![Плата, вид снизу][board_bottom]

Поскольку встроенный генератор у КР512ВИ1 нестабилен, к тому же работает
только на частотах от 1 МГц, что ведет к значительному энергопотреблению
(1.5 мА на частоте в 1 МГц, против 50 мкА на частоте в 32 КГц), то
инженеры IBM (и я вслед за ними) использовали внешний генератор на микросхеме MC14069. 
В наших краях полного аналога этой микросхемы не водится, поэтому
генератор собран на её функциональном аналоге К561ЛН2, резисторе R3
и конденсаторе C3, с кварцем Y1 на 32 КГц.

![Схема][scheme_board]
![Спецификация][scheme_specification]


### Описание схемы.

{.no-indent}
Работа с КР512ВИ1 осуществляется в два этапа:

1. выбор регистра ВИ1 (ячейки её памяти);
2. чтение/запись этого регистра;

Выбор регистра происходит по положительному импульсу на входе AS. 
Чтение/запись регистра реализованы по схеме шины "Intel", когда чтение данных
происходит при отрицательном импульсе на входе DS, а запись - при
отрицательном импульсе на входе R/<span class="signal-low">W</span>. То есть, вход DS можно
назвать /RD, а вход R/<span class="signal-low">W</span> можно назвать /WR.

Активный уровень сигнала /CE (логический 0) должен поддерживаться на протяжении всего 
цикла — от выбора регистра до завершения его чтения/записи. Это обеспечивается триггерной
схемой на элементах U3.3, U6.1, U6.2 и U6.3.

#### Триггерная схема.

Триггерная схема работает следующим образом. В исходном состоянии:

- входы /READ и /WRITE находятся в неактивном состоянии (логическая 1);
- вход ALE - в неактивном состоянии (логический 0);
- вход 3 элемента U6.1, через обратную связь, установлен в логический 0;
- на выходе U6.1 логическая 1;
- на выходе U6.3 (сигнал /CE для ВИ1) - логическая 1;
- триггер сброшен;

При поступлении импульса ALE на выходе U6.1 устанавливается логический 0. 
На выходе U6.2 соответственно появляется логическая 1. 
Сигнал /CE переходит в активный уровень (логический 0), активируя ВИ1.
Одновременно, через цепь обратной связи, на входе 3 элемента U6.1 устанавливается
логическая 1. Это блокирует изменение выхода U6.1 независимо от дальнейшего 
состояния ALE. Таким образом, триггер удерживает /CE в активном состоянии до следующего 
этапа чтения/записи регистра.

При переходе /READ или /WRITE в активное состояние (логический 0) на выходе U3.3 
устанавливается логическая 1. Это приводит к логическому 0 на выходе U6.2.
Через обратную связь на входе 3 элемента U6.1 также устанавливается логический 0,
а на выходе U6.1 соответственно логическая 1.
То есть, триггер возвращается в исходное состояние.

Благодаря прямой связи между выходом U3.3 и входом 9 элемента U6.3 
сигнал /CE продолжает удерживаться в активном уровне (логический 0), сохраняя ВИ1 активной.

После завершения чтения/записи регистра сигналы /READ и /WRITE возвращаются в 
неактивное состояние (логическая 1). Соответственно выход U3.3 переходит в логический 0
и снимается принудительное удержание /CE в 0.
Сигнал /CE устанавливается в логическую 1 (неактивное состояние) и ВИ1 отключается от 
шины данных компьютера, завершая цикл чтения/записи.
 
#### Дешифратор.

Дешифратор реализован на элементах U1, U4, U5 и частично U3.
Микросхема U1 выдает разрешение на дальнейшую работу дешифратора, если поступил
адрес в диапазоне 20h-21h.

Элемент U5.3 выдает разрешение на формирование сигнала ALE, если на адресной
линии A0 логический 0. С неё логическая 1 поступает на вход U5.1, которая формирует
сигнал ALE, если активен сигнал /IOW. Таким образом, начало работы с ВИ1 возможно
только по записи в порт 20h.

Элемент U5.4 выдает разрешение на формирование сигнала чтения/записи регистра ВИ1, 
если на адресной линии A0 логическая 1. Сигнал с неё поступает на U3.2 и U3.1, которые и 
формирует сигналы /READ или /WRITE, в зависимости от активного сигнала на линиях /IOR и /IOW. 
То есть, чтение/запись регистра ВИ1 производится с адреса 21h.


#### Пример.

Из вышесказанного алгоритм работы с ВИ1 довольно простой. Сначала посылаем в порт 20h номер
регистра, который мы хотим прочитать/изменить. Следом читаем/изменяем значение регистра
через порт 21h.

Ниже простой пример на бейсике. В строке 10 задаем частоту генератора (у нас 32 КГц).
В строках 15-35 устанавливаем формат и начальное время, а в строках 50-80
в бесконечном цикле читаем значения часов и выводим на экран.

![Пример на бейсике][example_code]

Поскольку в примере не проверяется старший бит ячейки 0Ah (см. документацию), то временами 
вместо каких либо значений часов, минут или секунд выводится значение 255. 
Это попытка чтения значения регистров ВИ1 в то время, когда она обновляет значения своих регистров
и просто отключается от шины данных компьютера, что и приводит к считыванию значения 0FFh.
Поэтому, по-хорошему всё это нужно делать на ассемблере и читать данные только при 
сброшенном старшем бите регистра 0Ah.


### Примечание.

Схема проектировалась под аккумулятор на 3.6 вольта, которые всё еще встречаются в продаже. 
В связи с этим, если вместо аккумулятора ставятся простые батарейки, то нужно убрать схему 
подзарядки, состоящую из диода D2 и резистора R2 - просто не распаивать их, чтобы на батарейки 
не шел ток заряда. 

Поскольку ВИ1 рассчитана на питание от 3 до 8 вольт, то контроллер прекрасно работает
как от одной "таблетки" в 3 Вольта, так и от двух сразу.  


### Ресурсы.

{.no-indent}
Более подробное описание работы с КР512ВИ1:

1. [Радиоежегодник 1989. Страница 37.][re89]
2. [Краткая тех. документация.][kr512vi1] 


[book_title]: images/book_title.jpg
[book_scheme]: images/scheme_ibm_pc_at.jpg
[board_top]: images/rtc-top-rev-1_0.jpg
[board_bottom]: images/rtc-bottom-rev-1_0.jpg

[example_code]: images/rtc-example-1.jpg

[scheme_board]: images/schema-RTC.png
[scheme_specification]: images/schema-RTC-power.png

[re89]: files/re89t.zip
[kr512vi1]: files/kr512vi1.zip
